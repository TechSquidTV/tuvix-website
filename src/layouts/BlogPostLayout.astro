---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const { title, description, publishedDate, author, authorAvatar, category, coverImage, coverAlt } =
  post.data;
const slug = post.id;

const formattedDate = new Intl.DateTimeFormat("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
}).format(publishedDate);

// Get image URL for OG meta tags
// With passthroughImageService, we can use the ImageMetadata directly
// The src property contains the path Astro uses to serve the image
let ogImageUrl: string;
if (coverImage) {
  // coverImage is an ImageMetadata object with a src property
  const imageSrc = typeof coverImage === "object" && "src" in coverImage 
    ? coverImage.src 
    : coverImage;
  // Construct absolute URL for OG tags
  ogImageUrl = new URL(imageSrc, Astro.site).href;
} else {
  // Use default OG image if no cover image
  ogImageUrl = new URL("/tuvix-og.webp", Astro.site).href;
}
---

<BaseLayout title={`${title} - Tuvix Blog`} description={description}>
  {/* Open Graph / Facebook */}
  <meta slot="head" property="og:type" content="article" />
  <meta slot="head" property="og:title" content={title} />
  <meta slot="head" property="og:description" content={description} />
  <meta slot="head" property="og:url" content={new URL(`/blog/${slug}`, Astro.site).href} />
  <meta slot="head" property="og:site_name" content="Tuvix" />
  <meta slot="head" property="og:image" content={ogImageUrl} />
  <meta slot="head" property="og:image:alt" content={coverAlt || title} />
  
  {/* Article specific */}
  <meta slot="head" property="article:published_time" content={publishedDate.toISOString()} />
  <meta slot="head" property="article:author" content={author} />
  {category && <meta slot="head" property="article:section" content={category} />}
  
  {/* Twitter */}
  <meta slot="head" name="twitter:card" content="summary_large_image" />
  <meta slot="head" name="twitter:title" content={title} />
  <meta slot="head" name="twitter:description" content={description} />
  <meta slot="head" name="twitter:image" content={ogImageUrl} />
  <article class="mx-auto max-w-4xl px-6 py-16">
    {/* Header */}
    <header class="mb-12">
      {/* Category & Date */}
      <div class="mb-4 flex items-center gap-4 text-sm text-gray-600">
        <span class="rounded-full bg-orange-100 px-3 py-1 text-orange-600">
          {category}
        </span>
        <time datetime={publishedDate.toISOString()}>{formattedDate}</time>
      </div>

      {/* Title */}
      <h1 class="mb-4 text-4xl font-bold tracking-tight text-gray-900 sm:text-5xl">
        {title}
      </h1>

      {/* Description */}
      <p class="text-xl text-gray-600">{description}</p>

      {/* Author */}
      <div class="mt-6 flex items-center gap-3">
        {authorAvatar ? (
          <img
            src={authorAvatar}
            alt={author}
            class="h-10 w-10 rounded-full object-cover"
          />
        ) : (
          <div class="h-10 w-10 rounded-full bg-orange-500 flex items-center justify-center text-white font-semibold">
            {author.charAt(0)}
          </div>
        )}
        <div>
          <p class="font-medium text-gray-900">{author}</p>
          <p class="text-sm text-gray-600">Author</p>
        </div>
      </div>
    </header>

    {/* Cover Image */}
    {
      coverImage && (
        <div class="mb-12">
          <Image
            src={coverImage}
            alt={coverAlt || title}
            class="aspect-video w-full rounded-xl object-cover"
            transition:name={`blog-image-${slug}`}
          />
        </div>
      )
    }

    {/* Content */}
    <div
      class="prose prose-lg prose-gray max-w-none
        prose-headings:font-bold prose-headings:tracking-tight
        prose-h1:text-4xl prose-h2:text-3xl prose-h3:text-2xl
        prose-p:text-gray-700 prose-p:leading-relaxed
        prose-a:text-orange-600 prose-a:no-underline hover:prose-a:underline
        prose-strong:text-gray-900 prose-strong:font-semibold
        prose-code:rounded prose-code:px-1.5 prose-code:py-0.5 prose-code:text-sm prose-code:font-mono prose-code:text-orange-400 prose-code:before:content-none prose-code:after:content-none
        prose-pre:rounded-xl prose-pre:bg-gray-900 prose-pre:text-gray-100
        prose-blockquote:border-l-4 prose-blockquote:border-orange-500 prose-blockquote:bg-orange-50 prose-blockquote:py-1 prose-blockquote:pl-4 prose-blockquote:pr-4 prose-blockquote:not-italic prose-blockquote:text-gray-700
        prose-ul:list-disc prose-ol:list-decimal
        prose-li:text-gray-700
        prose-table:border-collapse prose-th:border prose-th:bg-gray-50 prose-th:p-3 prose-td:border prose-td:p-3
        prose-img:mx-auto prose-img:rounded-lg"
    >
      <style>
        /* Apply gray background only to inline code, not code in pre blocks */
        .prose :is(:where(code):not(:where([class~="not-prose"],[class~="not-prose"] *))):not(pre code) {
          background-color: var(--color-gray-100);
        }
        /* Remove all backgrounds from code inside pre blocks */
        .prose pre code,
        .prose pre code *,
        .prose pre.astro-code code,
        .prose pre.astro-code code *,
        .prose pre code span,
        .prose pre code .line,
        .prose pre code .line span {
          background-color: transparent !important;
          background: transparent !important;
          color: #fb923c !important;
          padding: 0 !important;
        }
        .prose pre,
        .prose pre.astro-code {
          background-color: #24292e !important;
          color: #fb923c !important;
        }
        /* Center images wrapped in links */
        .prose a:has(img) {
          display: block;
          text-align: center;
        }
      </style>
      <slot />
    </div>

    {/* Footer */}
    <footer class="mt-16 border-t border-gray-200 pt-8">
      <div class="flex items-center justify-between">
        <a
          href="/blog"
          class="text-orange-600 hover:text-orange-700 font-semibold"
        >
          ‚Üê Back to Blog
        </a>
        <div class="text-sm text-gray-600">
          Published on {formattedDate}
        </div>
      </div>
    </footer>
  </article>
</BaseLayout>
